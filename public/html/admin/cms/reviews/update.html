<div id="admin-section"></div>

<script type="text/javascript">

    addActionSelect("changeLang", [{value: "nl", text: "Nederlands"}, {value: "fr", text: "Frans"}, {value: "en", text: "Engels"}]);
    addActionButton("back", "Terug");
    addActionButton("save", "Opslaan");
    addActionMenu([
        { id: "remove", label: "Verwijderen" }
    ])
    setMainTitle("Wijzig review");

    let _artists;

    function main() {
        getData( "/api/review?id="+getUrlParam("id"), data => {
            
            if (data == null) return addNotification("Item niet gevonden.", "failed");
            
            getArtists(function() {
                createAdminSection(data);

                // Auto-acknowledge notification
                postData("/api/notification/acknowledge", { relatedIds: [data._id] }, 
                    data => {                
                        console.log("Notification auto-acknowledged");
                        checkNotifications();
                    }, 
                    err => { addNotification("Notificatie kon niet geupdated worden: " + err, "failed"); }
                );

            });
        });        
    }
    main();

    function createAdminSection(data) {
        console.log(data);
        var lang = getAdminLang();
        var html = '<div class="grid_6">';
                
        html += '<h5>Vaste gegevens</h5>';
        html += '<form id="fixedData">';
        // html += adminCreateInput("date", "createdAt", "", "Datum");
        html += adminCreateRating("rating", data.fixed.rating, "Score");
        html += adminCreateInput("text", "customerName", data.fixed.customerName, "Naam klant");
        html += adminCreateInput("text", "customerEmail", data.fixed.customerEmail, "E-mail klant");

        let artist = "";
        if (data.fixed.artist) {
            matchingArtist = _artists.find(artist => { return similarity(data.fixed.artist, artist.fixed.name) > 0.8 });
            artist = matchingArtist.fixed.name;
        }

        html += adminCreateSelect(artistsSelectArray, "artist", artist, "Kunstenaar");
        html += adminCreateSelect([{value: "true", text: "Ja"}, {value: "false", text: "Nee"}], "reviewed", data.fixed.reviewed.toString(), "Geverifieerd");
        html += adminCreateSelect([{value: "true", text: "Ja"}, {value: "false", text: "Nee"}], "accepted", data.fixed.accepted.toString(), "Geaccepteerd");
        html += '</form><br><br>';

        html += '<h5>Taal afhankelijke gegevens</h5>';
        html += '<form id="languageData">';
        html += adminCreateRequiredInput("text", "title", data[lang].title, "Titel");        
        html += adminCreateRequiredTextarea("reviewText", data[lang].reviewText, "Tekst");
        html += '<br>';
        html += adminCreateRequiredInput("text", "originalTitle", data[lang].originalTitle, "Titel (origineel)");
        html += adminCreateRequiredTextarea("originalReviewText", data[lang].originalReviewText, "Tekst (origineel)");
        html += '</form>';
        
        html += adminCreateInput("hidden", "_id", data._id);

        $("#admin-section").html(html);

        // Disable editing original title and text
        $("#originalTitle").attr("disabled", true);
        $("#originalReviewText").attr("disabled", true);
        

        $(".rating").rate({
            max_value: 5,
            step_size: 0.5,
            cursor: 'pointer'
        });
    } 

    var artistsSelectArray = Array();
    function getArtists(cb) {
        getData("/api/artist", 
            artists => {
                _artists = artists;

                artistsSelectArray.push({value: "", text: ""});
                artists.forEach(artist => {
                    artistsSelectArray.push({value: artist.fixed.name, text: artist.fixed.name});
                });
                if (cb) cb();
            },
            err => { console.log(err); }
        );
    }

    function save() {

        var savingNotif = addNotification('<i class="fas fa-spinner fa-pulse"></i> Bezig met opslaan...');

        var fixedData = getFormData("fixedData", err => {
            removeNotification(savingNotif);
            return addNotification("Fout bij opslaan: " + err, "failed");
        });
        var languageData = getFormData("languageData", err => {
            removeNotification(savingNotif);
            return addNotification("Fout bij opslaan: " + err, "failed");
        });

        var formData = new FormData();
        $("input[type=hidden]").each(function() {
            formData.append($(this).attr('id'), $(this).val());
        });
        formData.append('lang', getAdminLang());
        formData.append('fixedData', JSON.stringify(fixedData));
        formData.append('languageData', JSON.stringify(languageData));

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/review/update', true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('authorization', getLocalStorage("token"));

        xhr.addEventListener('readystatechange', function(e) {
            if (xhr.readyState == 4 && xhr.status == 200) {
                removeNotification(savingNotif);
                addNotification("Succesvol opgeslagen.", "success");
                main();
            }
            else if (xhr.readyState == 4 && xhr.status != 200) {
                removeNotification(savingNotif);
                var response = JSON.parse(xhr.response);
                addNotification("Fout bij opslaan: " + response.err, "failed");
            }
        });
        xhr.send(formData);
    }

    function remove() {
        confirm("Verwijderen", "Zeker dat je deze review wil verwijderen", function() {
            var formData = {};
            $("input[type=hidden]").each(function() {
                formData[$(this).attr('id')] = $(this).val();
            });
            postData( "/api/review/delete", formData, data => { 
                back();
            }, err => { 
                addNotification("Fout bij verwijderen: " + JSON.stringify(err), "failed");
            });
        }) ;
    }

    function changeLang() {
        getData( "/api/review?id="+getUrlParam("id"), data => { createAdminSection(data) });
    }

</script>