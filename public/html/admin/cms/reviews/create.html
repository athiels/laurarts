<div id="admin-section"></div>

<script type="text/javascript">    

    addActionButton("back", "Terug");
    addActionButton("save", "Opslaan");
    setMainTitle("Nieuwe review");

    function createAdminSection() {
        var html = '<div class="grid_6">';
                
        html += '<h5>Vaste gegevens</h5>';
        html += '<form id="fixedData">';
        // html += adminCreateInput("date", "createdAt", "", "Datum");
        html += adminCreateRating("rating", "", "Score");
        html += adminCreateInput("text", "customerName", "", "Naam klant");
        html += adminCreateInput("text", "customerEmail", "", "E-mail klant");
        html += adminCreateSelect(artistsSelectArray, "artist", "", "Kunstenaar");
        html += adminCreateSelect([{value: "true", text: "Ja"}, {value: "false", text: "Nee"}], "reviewed", "", "Geverifieerd");
        html += adminCreateSelect([{value: "true", text: "Ja"}, {value: "false", text: "Nee"}], "accepted", "", "Geaccepteerd");
        html += '</form><br><br>';

        html += '<h5>Taal afhankelijke gegevens</h5>';
        html += '<form id="languageData">';
        html += adminCreateRequiredInput("text", "title", "", "Titel");
        html += adminCreateRequiredTextarea("reviewText", "", "Tekst");
        html += '</form>';

        $("#admin-section").html(html);

        $(".rating").rate({
            max_value: 5,
            step_size: 0.5,
            cursor: 'pointer'
        });

    } 

    getArtists(function() {
        createAdminSection();
    });

    var artistsSelectArray = Array();
    function getArtists(cb) {
        getData("/api/artist", 
            artists => {
                artistsSelectArray.push({value: "", text: ""});
                artists.forEach(artist => {
                    artistsSelectArray.push({value: artist.fixed.name, text: artist.fixed.name});
                });
                if (cb) cb();
            },
            err => { console.log(err); }
        );
    }

    $(".rating").on("afterChange", function(ev, data){
        console.log(data.from, data.to);
    });

    function save() {

        if (!validateForm()) return $.alert("Gelieve alle velden met een * in te vullen.");

        var savingNotif = addNotification('<i class="fas fa-spinner fa-pulse"></i> Bezig met opslaan...');

        var fixedData = getFormData("fixedData", err => {
            removeNotification(savingNotif);
            return addNotification("Fout bij opslaan: " + err, "failed");
        });
        var languageData = getFormData("languageData", err => {
            removeNotification(savingNotif);
            return addNotification("Fout bij opslaan: " + err, "failed");
        });

        var formData = new FormData();
        formData.append('lang', "nl");
        formData.append('fixedData', JSON.stringify(fixedData));
        formData.append('languageData', JSON.stringify(languageData));

        var xhr = new XMLHttpRequest();        
        xhr.open('POST', '/api/review/create', true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('authorization', getLocalStorage("token"));

        xhr.addEventListener('readystatechange', function(e) {
            if (xhr.readyState == 4 && xhr.status == 200) {
                removeNotification(savingNotif);
                return back();
            }
            else if (xhr.readyState == 4 && xhr.status != 200) {
                removeNotification(savingNotif);
                var response = JSON.parse(xhr.response);
                addNotification("Fout bij opslaan: " + response.err, "failed");
            }
        });
        xhr.send(formData);
    }
</script>