<ul id="admin-table" class="admin-table grid_12"></ul>
<br class="clear">


<script type="text/javascript">

    addActionButton("acknowledgeAll", "Alles markeren als gelezen");
    addActionButton("deleteAcknowledged", "Verwijder gelezen");

    let notifications;

    function main() {
        getData("/api/notification", data => { createAdminSection(data) }, err => { addNotification("Fout bij het ophalen van data: " + err, "failed"); });
    }
    main();

    function createAdminSection(data) {
        console.log(data);
        setMainTitle("Notifications");
        setSubTitle(data.length + " items");

        notifications = data;

        $("#admin-table").empty();
        data.forEach(notification => {
            let html = '<li id="' + notification._id + '" class="grid_12 ' + (!notification.acknowledged? 'unacknowledged' : '') + '">';
            // html += '<div class="grid_1">' + (notification.acknowledged ? '<i class="fas fa-bell"></i>' : '<i class="fas fa-bell-slash"></i>') + '</div>';
            html += '<div class="grid_2 ellipsis">' + formatDateTime(notification.createdAt) + '</div>';
            html += '<div class="grid_4 ellipsis"><strong>' + notification.title + '</strong></div>';
            html += '<div class="grid_6 ellipsis">' + notification.message + '</div>';
            html += '</li>';

            $("#admin-table").append(html);
        });
        setMainHeight();
    }

    $(document).on("click", "#admin-table li", function () {
        id = $(this).attr('id');
        thisNotification = notifications.find(notification => { return notification._id == id });

        if (thisNotification.acknowledged && thisNotification.url) {
            return location.href = thisNotification.url;
        }
        postData("/api/notification/acknowledge", { ids: [id] }, 
            data => {
                $(this).removeClass('unacknowledged');
                thisNotification.acknowledged = true;
                if (thisNotification.url) { location.href = thisNotification.url; }
                else checkNotifications();          
            }, err => { addNotification("Notificatie kon niet geupdated worden: " + err, "failed"); });
    });

    function acknowledgeAll() {
        confirm("Alles markeren als gelezen", "Ben je zeker dat je alle notificaties wil markeren als gelezen?", () => {
            unacknowledgedNotificationIds = notifications.filter(notification => { return !notification.acknowledged }).map(notification => { return notification._id });
            postData("/api/notification/acknowledge", { ids: unacknowledgedNotificationIds }, 
            data => {
                unacknowledgedNotificationIds.forEach(id => {
                    $("#" + id).removeClass('unacknowledged');
                });
                checkNotifications();          
            }, err => { addNotification("Notificatie kon niet geupdated worden: " + err, "failed"); });
        });
    }

    function deleteAcknowledged() {
        confirm("Alles gelezen notificaties verwijderen", "Ben je zeker dat je alle notificaties gelezen notificaties wil verwijderen? Dit kan niet ongedaan gemaakt worden.", () => {
            acknowledgedNotificationIds = notifications.filter(notification => { return notification.acknowledged }).map(notification => { return notification._id });
            postData("/api/notification/delete", { ids: acknowledgedNotificationIds }, 
            data => {
                main();
                checkNotifications();          
            }, err => { addNotification("Notificatie(s) kon(den) niet verwijderd worden: " + err, "failed"); });
        });
    }

</script>